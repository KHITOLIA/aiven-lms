{% extends 'layout.html' %}
{% block content %}
<style>
    .stats-card-main {
        background: linear-gradient(135deg, #A020F0, #5C3A9B);
        color: #fff;
        border-radius: 15px;
        padding: 2rem;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .progress-bar-container {
        height: 25px;
        background-color: #3a3250;
        border-radius: 12px;
        margin-bottom: 15px;
    }
    .progress-bar-fill {
        height: 100%;
        width: {{ overall_progress_percent }}%;
        background-color: var(--accent-color);
        border-radius: 12px;
        transition: width 1s ease-in-out;
        text-align: right;
        padding-right: 10px;
        color: #1a1a2e;
        font-weight: 600;
        line-height: 25px;
    }
    .next-lesson-card {
        background: #22223b;
        border-left: 5px solid var(--highlight-color);
        transition: transform 0.3s;
    }
    .next-lesson-card:hover {
        transform: translateY(-5px);
    }
    .youtube-search-card {
        background: #22223b;
        border: 1px solid #FF4500;
    }
    .query-card {
        background: #22223b;
        border-left: 5px solid #00FFFF;
        margin-bottom: 15px;
        border-radius: 8px;
        padding: 15px;
        color: var(--primary-text-bright);
        position: relative;
        transition: all 0.3s ease;
    }
    .query-card.fade-out {
        opacity: 0;
        transform: translateX(30px);
    }
    .delete-btn {
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        color: #ff5555;
        cursor: pointer;
        font-size: 1rem;
        transition: color 0.3s ease;
    }
    .delete-btn:hover {
        color: #ff7777;
    }
    .trainer-reply {
        background-color: rgba(0, 255, 127, 0.1);
        border: 1px solid #00FF7F;
        color: #00FF7F;
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
    }
    .raise-query-card {
        background: #22223b;
        border-left: 5px solid #FF4500;
        border-radius: 8px;
        padding: 20px;
    }
</style>

<h3 class="mb-5">Student Dashboard</h3>

<div class="row g-4 mb-5">
    <div class="col-md-12">
        <div class="stats-card-main">
            <h5 class="mb-3">Overall Learning Progress</h5>
            <div class="progress-bar-container">
                <div class="progress-bar-fill" role="progressbar" aria-valuenow="{{ overall_progress_percent }}" aria-valuemin="0" aria-valuemax="100">
                    {{ overall_progress_percent }}%
                </div>
            </div>
            <p class="mb-0 text-white-50">Keep pushing! Consistency is the key to mastery.</p>
        </div>
    </div>
</div>

<div class="row g-4">
    <div class="col-md-6">
        <div class="card p-4 shadow-sm next-lesson-card h-100">
            <h5 class="card-title text-success"><i class="fas fa-play-circle"></i> Continue Learning</h5>
            {% if next_lesson %}
                <p>Ready for the next step? Dive right back into your course.</p>
                <div class="alert alert-info d-flex justify-content-between align-items-center p-3" style="background-color: rgba(0, 255, 255, 0.1); border-color: #00FFFF; color: #00FFFF;">
                    <div>
                        <strong>{{ next_lesson.recording_name }}</strong><br>
                        <small class="text-white-50">In Batch: {{ next_lesson.batch_name }}</small>
                    </div>
                    <a href="{{ url_for('view_batch', batch_id=next_lesson.batch_id) }}" class="btn btn-sm btn-outline-info">Go to Video</a>
                </div>
            {% else %}
                <p class="text-center text-warning">üéâ Congratulations! You have completed all available content.</p>
            {% endif %}
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-4 shadow-sm youtube-search-card h-100">
            <h5 class="card-title" style="color: #FF4500;"><i class="fab fa-youtube"></i> Find Supplemental Resources</h5>
            <p class="small-muted">Search directly on YouTube for tutorials or deeper explanations.</p>
            
            <form method="get" action="https://www.youtube.com/results" target="_blank" class="mt-3">
                <div class="input-group">
                    <input type="text" class="form-control" name="search_query" placeholder="Search Python, Flask, or MLOps..." required>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- === MY COURSES === -->
<div class="row mt-4">
    <div class="col-md-12">
        <div class="card p-4 shadow-sm">
            <h5 class="card-title">My Enrolled Courses</h5>
            <div class="list-group list-group-flush mt-3">
                {% for e in enrollments %}
                <a href="{{ url_for('view_batch', batch_id=e.batch.id) }}" class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ e.batch.name }}</strong><br>
                        <small class="small-muted">{{ e.batch.description or 'No description provided.' }}</small>
                    </div>
                </a>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- === QUERY SECTION === -->
<div class="row mt-5">
    <div class="col-md-6">
        <div class="raise-query-card shadow-sm">
            <h5 class="text-warning mb-3"><i class="fas fa-question-circle"></i> Raise a Query</h5>
            <form id="queryForm">
                <div class="mb-3">
                    <label for="batch_id" class="form-label text-light">Select Batch</label>
                    <select class="form-select" id="batch_id" required>
                        <option value="">-- Choose your batch --</option>
                        {% for e in enrollments %}
                        <option value="{{ e.batch.id }}">{{ e.batch.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label for="query_message" class="form-label text-light">Your Question</label>
                    <textarea class="form-control" id="query_message" rows="3" placeholder="Write your query..." required></textarea>
                </div>
                <button type="submit" class="btn btn-outline-warning w-100">Submit Query</button>
            </form>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card p-4 shadow-sm">
            <h5 class="card-title text-info"><i class="fas fa-comments"></i> My Queries</h5>
            <div id="studentQueries" class="mt-3">
                <p class="text-muted text-center">Loading your queries...</p>
            </div>
        </div>
    </div>
</div>

<script>
async function loadQueries() {
  const res = await fetch("/student/queries/json");
  if (!res.ok) {
    document.getElementById("studentQueries").innerHTML =
      "<p class='text-danger text-center'>Failed to load queries.</p>";
    return;
  }

  const data = await res.json();
  if (data.length === 0) {
    document.getElementById("studentQueries").innerHTML =
      "<p class='text-muted text-center'>No queries raised yet.</p>";
    return;
  }

  const html = data.map(q => `
    <div class="query-card" id="query-${q.id}">
        <button class="delete-btn" onclick="deleteQuery(${q.id})">
          <i class="fas fa-trash"></i>
        </button>
        <p><strong>Batch:</strong> ${q.batch_name || 'General'}</p>
        <p>${q.message}</p>
        <small class="text-white-50">${new Date(q.created_at).toLocaleString()}</small>
        ${
          q.reply
            ? `<div class="trainer-reply"><strong>Trainer Reply:</strong> ${q.reply}</div>`
            : `<div class="text-muted mt-2">‚è≥ Awaiting trainer's response...</div>`
        }
    </div>
  `).join('');

  document.getElementById("studentQueries").innerHTML = html;
}

// üóë Delete query
async function deleteQuery(id) {
  if (!confirm("Are you sure you want to delete this query?")) return;
  try {
    const res = await fetch(`/student/delete_query/${id}`, { method: "DELETE" });
    if (res.ok) {
      const el = document.getElementById(`query-${id}`);
      el.classList.add("fade-out");
      setTimeout(() => el.remove(), 400);
    } else {
      alert("Failed to delete query.");
    }
  } catch (err) {
    console.error(err);
    alert("Error deleting query.");
  }
}

// Submit new query
document.getElementById("queryForm").addEventListener("submit", async (e) => {
  e.preventDefault();
  const batch_id = document.getElementById("batch_id").value;
  const message = document.getElementById("query_message").value.trim();
  if (!batch_id || !message) return alert("Please select a batch and enter your query.");

  const res = await fetch("/student/add_query", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ batch_id, message })
  });

  if (res.ok) {
    alert("Query submitted successfully!");
    document.getElementById("query_message").value = "";
    loadQueries();
  } else {
    alert("Error sending query.");
  }
});

loadQueries(); // initial load
</script>
{% endblock %}
