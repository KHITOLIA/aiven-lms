{% extends 'layout.html' %}
{% block content %}
<style>
    .stats-card {
        background: linear-gradient(135deg, #1e3c72, #2a5298);
        color: #fff;
        border-radius: 15px;
        padding: 1.5rem;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        height: 100%;
    }
    .stats-card h4 {
        font-size: 2.5rem;
        margin-bottom: 0.5rem;
    }
    .profile-card {
        background: #22223b;
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
    }
    .profile-card img {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid var(--highlight-color);
        margin-bottom: 10px;
    }
    .profile-card h5 {
        color: var(--accent-color);
        margin-bottom: 0;
    }
    .profile-card p {
        color: var(--secondary-text-clear);
        font-size: 0.9rem;
    }
    .query-item {
        border-left: 5px solid #FF4500;
        margin-bottom: 15px;
        border-radius: 5px;
        background-color: rgba(255, 69, 0, 0.08) !important;
        color: var(--primary-text-bright);
        transition: all 0.4s ease;
    }
    .batch-actions {
        display: flex;
        gap: 10px;
        min-width: 250px;
    }
    .query-status-btns {
        display: flex;
        gap: 6px;
        margin-top: 5px;
    }
    .reply-box {
        margin-top: 10px;
    }
    textarea.reply-textarea {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #444;
        background-color: #2a2a40;
        color: #fff;
        padding: 8px;
        resize: none;
    }
    .in-progress {
    border-left-color: #FFD700 !important;
    background-color: rgba(255, 215, 0, 0.08) !important;
    }
</style>

<h3 class="mb-5">Trainer Dashboard</h3>

<div class="row g-4 mb-5">
    <div class="col-md-4">
        <div class="profile-card h-100">
            {% if trainer.profile_pic %}
                <img src="{{ url_for('static', filename='profiles/' + trainer.profile_pic) }}" alt="Profile">
            {% else %}
                <i class="fas fa-user-circle fa-4x text-secondary mb-2"></i>
            {% endif %}
            <h5 class="mb-1">{{ trainer.name }}</h5>
            <p class="mb-0">{{ trainer.expertise or 'General Mentor' }}</p>
            <a href="{{ url_for('trainer_profile') }}" class="btn btn-sm btn-outline-info mt-2">Edit Profile</a>
        </div>
    </div>

    <div class="col-md-4">
        <div class="stats-card">
            <h4>{{ batches|length }}</h4>
            <p>Assigned Batches</p>
        </div>
    </div>

    <div class="col-md-4">
        <div class="stats-card">
            <h4>{{ total_recordings_assigned }}</h4>
            <p>Total Content Items</p>
        </div>
    </div>
</div>

<div class="row mt-4">
    <!-- âœ… Live Queries Panel -->
    <div class="col-md-6">
        <div class="card p-4 shadow-sm h-100">
            <h5 class="card-title text-warning">
                <i class="fas fa-envelope-open-text"></i> Student Queries
            </h5>
            <div id="trainer-queries" class="list-group list-group-flush mt-3">Loading...</div>
        </div>
    </div>

    <!-- âœ… Batch Management Panel -->
    <div class="col-md-6">
        <div class="card p-4 shadow-sm h-100">
            <h5 class="card-title">My Assigned Batches</h5>
            <div class="list-group list-group-flush mt-3">
                {% for b in batches %}
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ b.name }}</strong><br>
                        <small class="small-muted">{{ b.description or 'No description provided.' }}</small>
                    </div>
                    <div class="batch-actions">
                        <a href="{{ url_for('view_batch', batch_id=b.id) }}" class="btn btn-sm btn-success">
                            <i class="fas fa-upload"></i> Manage Content
                        </a>
                        <a href="{{ url_for('view_batch_enrollments', batch_id=b.id) }}" class="btn btn-sm btn-outline-info">
                            <i class="fas fa-users"></i> View Progress
                        </a>
                    </div>
                </div>
                {% else %}
                <li class="list-group-item text-center text-muted">No batches are currently assigned to you.</li>
                {% endfor %}
            </div>
        </div>
    </div>
</div>

<!-- âœ… Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  async function loadTrainerQueries() {
    const container = document.getElementById('trainer-queries');
    try {
      const res = await fetch('/trainer/queries/json');
      const qs = await res.json();
      if (!Array.isArray(qs) || qs.length === 0) {
        container.innerHTML = '<div class="text-muted text-center">No open queries ðŸŽ‰</div>';
        return;
      }
      let html = '';
      qs.forEach(q => {
        if (q.status === 'Resolved') return;
        const activeClass = q.status === 'In Progress' ? 'in-progress' : '';
        html += `
          <div class="list-group-item query-item ${activeClass}" id="query-${q.id}">
            <p class="mb-1"><strong>${q.student_name}</strong> (${q.batch_name || 'General'})</p>
            <p class="small-muted mb-0">${q.message}</p>
            <small class="text-white-50">${new Date(q.created_at).toLocaleString()}</small>
            <div><span class="text-info fw-bold">${q.status}</span></div>

            <div class="reply-box">
              <label class="small text-white-50">Your Reply:</label>
              <textarea id="reply-${q.id}" class="reply-textarea" rows="2" placeholder="Write your reply here...">${q.reply || ''}</textarea>
              <div class="query-status-btns">
                <button class="btn btn-sm btn-outline-success" onclick="sendReply(${q.id})">
                  <i class="fas fa-paper-plane"></i> Send Reply
                </button>
                <button class="btn btn-sm btn-outline-warning" onclick="updateStatus(${q.id}, 'In Progress')">
                  <i class="fas fa-hourglass-half"></i> In Progress
                </button>
                <button class="btn btn-sm btn-outline-success" onclick="updateStatus(${q.id}, 'Resolved')">
                  <i class="fas fa-check"></i> Resolve
                </button>
              </div>
            </div>
          </div>`;
      });
      container.innerHTML = html || '<div class="text-muted text-center">No open queries ðŸŽ‰</div>';
    } catch (err) {
      console.error(err);
      container.innerHTML = '<div class="text-danger">Failed to load queries.</div>';
    }
  }

  window.updateStatus = async (id, status) => {
    try {
      const res = await fetch(`/trainer/update_query_status/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({status})
      });

      if (res.ok) {
        const card = document.getElementById(`query-${id}`);
        if (!card) return;

        if (status === 'Resolved') {
          card.style.opacity = '0';
          card.style.transform = 'translateX(40px)';
          setTimeout(() => card.remove(), 400);
        } else if (status === 'In Progress') {
          card.classList.add('in-progress');
          const statusLabel = card.querySelector('.fw-bold');
          if (statusLabel) statusLabel.textContent = 'In Progress';
        }
      } else alert('Failed to update query status.');
    } catch (err) {
      console.error(err);
      alert('Error updating status.');
    }
  };

  window.sendReply = async (id) => {
    const reply = document.getElementById(`reply-${id}`).value.trim();
    if (!reply) return alert('Please write a reply before sending.');
    try {
      const res = await fetch(`/trainer/reply_query/${id}`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({reply})
      });
      if (res.ok) {
        const card = document.getElementById(`query-${id}`);
        if (card) {
          card.style.opacity = '0';
          card.style.transform = 'translateX(40px)';
          setTimeout(() => card.remove(), 400);
        }
      } else alert('Failed to send reply.');
    } catch (err) {
      console.error(err);
      alert('Error sending reply.');
    }
  };

  loadTrainerQueries();
});
</script>

{% endblock %}
